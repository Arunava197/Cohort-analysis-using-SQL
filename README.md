# Leveraging SQL for Cohort Analysis in Retail Data ðŸš€

Cohort analysis is an essential tool for understanding customer behavior and lifetime valueHereâ€™s a breakdown of how you can perform cohort analysis on retail data using SQL:

## Database and Schema Setup:

*Create a new database and schema to organize your data.

*Define the retail data table with necessary fields such as InvoiceNo, StockCode, Description, Quantity, InvoiceDate, UnitPrice, CustomerID, and Country.

## Data Preparation:

*Clean and filter the data, ensuring only valid transactions are included.

*Convert InvoiceDate to a date format and calculate revenue per transaction.

## Customer Cohort Identification:

*Assign each customer to a cohort based on their first purchase month.

*Calculate the purchase month for each transaction and identify the first purchase month for each customer.

## Cohort Analysis on Customer Count:
*Create a cohort table to analyze the number of customers over time.

*Use pivot tables to show the number of customers per cohort over a 12-month period.

## Customer Lifetime Value (CLV) Analysis:

*Calculate the revenue generated by each cohort over time.

*Use pivot tables to display the sum of revenue per cohort over a 12-month period.
![Screenshot 2024-07-07 201542](https://github.com/Arunava197/Cohort-analysis-using-SQL/assets/160317839/123b23cd-9090-42fc-a03b-cf0357cfb9f0)
![Screenshot 2024-07-07 201557](https://github.com/Arunava197/Cohort-analysis-using-SQL/assets/160317839/5ea0a7f3-5b11-4f9c-b5e6-d775bbbdf09c)
![Screenshot 2024-07-07 201617](https://github.com/Arunava197/Cohort-analysis-using-SQL/assets/160317839/1581bc13-920b-47f4-b784-93ba871ff889)

# Code:

CREATE DATABASE SALES;
USE DATABASE SALES;
CREATE SCHEMA COHORT_ANALYSIS;
USE SCHEMA  COHORT_ANALYSIS;

CREATE OR REPLACE TABLE RETAIL (
    InvoiceNo varchar (10),
    StockCode varchar (20),
    Description varchar (200),
    Quantity number (8,2),
    InvoiceDate varchar (30),
    Unitprice number (8,2),
    CustomerID number (10),
    Country varchar (25)
);

--TRUNCATE RETAIL

SELECT * FROM RETAIL
LIMIT 10;

SELECT COUNT(*) FROM RETAIL; -- 22,190 Records

--Cohort analysis with no of customer

WITH CTE1 AS
(SELECT 
    INVOICENO,CUSTOMERID,
    TO_DATE (INVOICEDATE, 'DD/MM/YY  HH24:MI') AS INVOICEDATE,
    ROUND(QUANTITY*UNITPRICE,2)  AS REVENUE
FROM RETAIL
    WHERE CUSTOMERID IS NOT NULL
        AND INVOICENO IS NOT NULL
        AND QUANTITY > 0
        AND UNITPRICE> 0),


CTE2 AS
(SELECT 
    INVOICENO, CUSTOMERID,INVOICEDATE,
    DATE_TRUNC('MONTH',INVOICEDATE) AS PURCHASE_MONTH,
    DATE_TRUNC('MONTH',MIN(INVOICEDATE) OVER (PARTITION BY CUSTOMERID ORDER BY INVOICEDATE)) AS FIRST_PURCHASE_MONTH
FROM CTE1),


CTE3 AS
(SELECT 
    CUSTOMERID,FIRST_PURCHASE_MONTH,
    CONCAT('MONTH_',DATEDIFF('MONTH',FIRST_PURCHASE_MONTH,PURCHASE_MONTH)) AS COHORT_MONTH
FROM CTE2)

SELECT * FROM CTE3
PIVOT(COUNT(CUSTOMERID) FOR COHORT_MONTH IN 
('MONTH_0','MONTH_1','MONTH_2','MONTH_3','MONTH_4','MONTH_5','MONTH_6','MONTH_7','MONTH_8','MONTH_9','MONTH_10','MONTH_11','MONTH_12'))
ORDER BY FIRST_PURCHASE_MONTH;


--Cohory analysis on customer lifetime value

WITH CTE1 AS
(SELECT 
    INVOICENO,CUSTOMERID,
    TO_DATE (INVOICEDATE, 'DD/MM/YY  HH24:MI') AS INVOICEDATE,
    ROUND(QUANTITY*UNITPRICE,2)  AS REVENUE
FROM RETAIL
    WHERE CUSTOMERID IS NOT NULL
        AND INVOICENO IS NOT NULL
        AND QUANTITY > 0
        AND UNITPRICE> 0),

CTE2 AS
(SELECT 
    INVOICENO, CUSTOMERID,INVOICEDATE,
    DATE_TRUNC('MONTH',INVOICEDATE) AS PURCHASE_MONTH,
    DATE_TRUNC('MONTH',MIN(INVOICEDATE) OVER (PARTITION BY CUSTOMERID ORDER BY INVOICEDATE)) AS FIRST_PURCHASE_MONTH, REVENUE
FROM CTE1),

CTE3 AS
(SELECT 
    FIRST_PURCHASE_MONTH,
    CONCAT('MONTH_',DATEDIFF('MONTH',FIRST_PURCHASE_MONTH,PURCHASE_MONTH)) AS COHORT_MONTH,
    ROUND (REVENUE,0) AS REVENUE
FROM CTE2)

SELECT * FROM CTE3
PIVOT(SUM(REVENUE) FOR COHORT_MONTH IN  
('MONTH_0','MONTH_1','MONTH_2','MONTH_3','MONTH_4','MONTH_5','MONTH_6','MONTH_7','MONTH_8','MONTH_9','MONTH_10','MONTH_11','MONTH_12'))
ORDER BY FIRST_PURCHASE_MONTH;






